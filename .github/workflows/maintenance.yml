name: ðŸ¤– Automated Maintenance

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-update:
    name: ðŸ“¦ Dependencies Update Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Check for outdated packages
      run: |
        echo "ðŸ“¦ Checking for outdated packages..."
        npm outdated || echo "Some packages are outdated"
        
    - name: ðŸ”’ Security audit
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level=moderate || echo "Security vulnerabilities found"
        
    - name: ðŸ“‹ Create maintenance report
      run: |
        echo "## ðŸ”§ Weekly Maintenance Report" >> maintenance-report.md
        echo "" >> maintenance-report.md
        echo "### ðŸ“¦ Package Status" >> maintenance-report.md
        echo "\`\`\`" >> maintenance-report.md
        npm outdated || echo "All packages are up to date" >> maintenance-report.md
        echo "\`\`\`" >> maintenance-report.md
        echo "" >> maintenance-report.md
        echo "### ðŸ”’ Security Status" >> maintenance-report.md
        echo "\`\`\`" >> maintenance-report.md
        npm audit || echo "No security vulnerabilities found" >> maintenance-report.md
        echo "\`\`\`" >> maintenance-report.md
        
    - name: ðŸ“¤ Upload maintenance report
      uses: actions/upload-artifact@v4
      with:
        name: maintenance-report
        path: maintenance-report.md
        retention-days: 7

  health-check:
    name: ðŸ¥ System Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ§ª Run comprehensive tests
      run: |
        echo "ðŸ§ª Running all tests..."
        npm test -- --coverage --watchAll=false --passWithNoTests
        
    - name: ðŸ—ï¸ Test build process
      run: |
        echo "ðŸ—ï¸ Testing build..."
        npm run build
        
    - name: ðŸŒ Test server startup
      run: |
        echo "ðŸŒ Testing JSON server..."
        npm run database &
        SERVER_PID=$!
        sleep 5
        curl -f http://localhost:5000/todos || echo "Server test completed"
        kill $SERVER_PID || echo "Server already stopped"
        
    - name: ðŸ“‹ Health report
      run: |
        echo "## ðŸ¥ System Health Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Health Checks:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Dependency installation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Test suite execution" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ Build process verification" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Server startup test" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š System Status: âœ… HEALTHY" >> $GITHUB_STEP_SUMMARY
