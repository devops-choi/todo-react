name: ðŸ› ï¸ Deploy JSON Server (Backend)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'database.json'
      - 'server.js'
      - 'server-package.json'
      - 'vercel.json'
      - '.github/workflows/deploy-json-server.yml'
  workflow_dispatch:

jobs:
  deploy-json-server:
    name: ðŸš€ Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Prepare server files
      run: |
        echo "ðŸ”§ Preparing server deployment files..."
        mkdir -p deploy
        cp server.js deploy/
        cp database.json deploy/
        cp server-package.json deploy/package.json
        cp vercel.json deploy/
        cp Procfile deploy/ 2>/dev/null || echo "Procfile not found, skipping..."
        
        echo "ðŸ“ Files prepared:"
        ls -la deploy/
        
    - name: ðŸ“¦ Install server dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        cd deploy
        npm install
        
    - name: ðŸ§ª Test server startup
      run: |
        echo "ðŸ§ª Testing server startup..."
        cd deploy
        timeout 10s npm start || echo "Server test completed"
        
    # Vercel Deployment
    - name: ðŸ” Check Vercel configuration
      id: check-vercel
      run: |
        if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âœ… Vercel token found"
          echo "has-vercel=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Vercel token not found"
          echo "has-vercel=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸš€ Deploy to Vercel
      if: steps.check-vercel.outputs.has-vercel == 'true'
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./deploy
        
    # Railway Deployment
    - name: ðŸ” Check Railway configuration
      id: check-railway
      run: |
        if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "âœ… Railway token found"
          echo "has-railway=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Railway token not found"
          echo "has-railway=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸš€ Deploy to Railway
      if: steps.check-railway.outputs.has-railway == 'true'
      uses: bervProject/railway-deploy@v1.0.2
      with:
        railway_token: ${{ secrets.RAILWAY_TOKEN }}
        service: ${{ secrets.RAILWAY_SERVICE_ID }}
        
    # Deployment Summary
    - name: ðŸ“‹ Deployment Summary
      run: |
        echo "## ðŸŽ¯ JSON Server Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Server files prepared" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Dependencies installed and tested" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-vercel.outputs.has-vercel }}" == "true" ]; then
          echo "- ðŸš€ Deployed to Vercel" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Vercel deployment skipped (token not configured)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.check-railway.outputs.has-railway }}" == "true" ]; then
          echo "- ðŸš€ Deployed to Railway" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Railway deployment skipped (token not configured)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Configuration Help:" >> $GITHUB_STEP_SUMMARY
        echo "To enable automatic deployment, add these secrets to your repository:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**For Vercel:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`VERCEL_TOKEN\` - Your Vercel API token" >> $GITHUB_STEP_SUMMARY
        echo "- \`VERCEL_ORG_ID\` - Your Vercel organization ID" >> $GITHUB_STEP_SUMMARY
        echo "- \`VERCEL_PROJECT_ID\` - Your Vercel project ID" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**For Railway:**" >> $GITHUB_STEP_SUMMARY        echo "- \`RAILWAY_TOKEN\` - Your Railway API token" >> $GITHUB_STEP_SUMMARY
        echo "- \`RAILWAY_SERVICE_ID\` - Your Railway service ID" >> $GITHUB_STEP_SUMMARY
